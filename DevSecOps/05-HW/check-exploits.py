# python -m pip install pytest-bandit
# python -m pip install flask
# python -m pip install flask-sqlalchemy
# python -m pip install spaghetti

# Ниже приведён не безопасный код :)

import os, re
from subprocess import Popen, PIPE

files_path = os.path.dirname(__file__)
files = [f for f in os.listdir(files_path) if re.match(r'\b[example-].*.py', f)]
configPath = os.path.join(files_path, "config.yml")
p1 = Popen(['bandit-config-generator', '-o', f"{configPath}"])

for filename in files:
    print(f"---------------------->> {filename}")
    filepath = os.path.join(files_path, filename)
    filebasename = os.path.basename(filepath).split('.')[0]
    outfilepath = os.path.join(files_path, f"{filebasename}-out.csv")
    # BANDIT
    p1 = Popen(['bandit', f"{filepath}", '-f', 'csv', '-o', f"{outfilepath}"], stdout=PIPE, stderr=PIPE, universal_newlines=True)
    stdout, stderr = p1.communicate()
    print (stdout)
    # SNYK
    p2 = Popen(['snyk-win', 'test', f"{filepath}", '--package-manager=pip', '--json'], stdout=PIPE, stderr=PIPE, universal_newlines=True)
    stdout, stderr = p2.communicate()
    print (stdout)

